# æ‹¾å…‰å½±è§†åç«¯ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
cd backend

# 1. åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„
npm run db:init

# 2. æ’å…¥çœŸå®èµ„æºç«™æ•°æ®
npx wrangler d1 execute robin-db --local --file=./seed_sources.sql
```

**éªŒè¯**: 
```bash
npm run db:query -- --command="SELECT * FROM video_sources"
```
åº”è¯¥çœ‹åˆ°5ä¸ªèµ„æºç«™è®°å½•ã€‚

---

## ğŸ”‘ ç¬¬äºŒæ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡å·²ç»åœ¨ `.dev.vars` æ–‡ä»¶ä¸­é…ç½®å¥½äº†é»˜è®¤å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

**å¦‚æœéœ€è¦ä¿®æ”¹**ï¼Œç¼–è¾‘ `backend/.dev.vars`:
```bash
JWT_SECRET=ä½ çš„JWTå¯†é’¥
ADMIN_SECRET_KEY=ä½ çš„ç®¡ç†åå°å¯†é’¥
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼ˆéƒ¨ç½²æ—¶ä½¿ç”¨ï¼‰:
```bash
wrangler secret put JWT_SECRET
wrangler secret put ADMIN_SECRET_KEY
```

---

## ğŸ¬ ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨åç«¯æœåŠ¡

```bash
npm run dev
```

æœåŠ¡å°†åœ¨ `http://localhost:8787` å¯åŠ¨ã€‚

---

## âœ… ç¬¬å››æ­¥ï¼šæµ‹è¯•æ¥å£

### 1. å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8787/
```
åº”è¯¥è¿”å›: `{"name":"Robin Video Platform API",...}`

### 2. æµ‹è¯•é¦–é¡µå¸ƒå±€
```bash
curl "http://localhost:8787/home_layout?tab=featured"
```

### 3. æµ‹è¯•è§†é¢‘åˆ—è¡¨ï¼ˆéœ€è¦å…ˆé…ç½®èµ„æºç«™ï¼‰
```bash
curl "http://localhost:8787/api/vod?ac=list&pg=1"
```

### 4. æµ‹è¯•æœç´¢
```bash
curl "http://localhost:8787/api/search?wd=ä¸‰ä½“"
```

---

## ğŸ¨ ç¬¬äº”æ­¥ï¼šå¯åŠ¨ç®¡ç†åå°

```bash
cd ../admin
npm install
npm run dev
```

ç®¡ç†åå°å°†åœ¨ `http://localhost:5173` å¯åŠ¨ã€‚

### ç™»å½•ç®¡ç†åå°

1. è®¿é—® `http://localhost:5173`
2. è¾“å…¥å¯†é’¥: `robin_admin_secret_2024_local_development`
3. è¿›å…¥ç®¡ç†åå°

---

## ğŸ“ ç¬¬å…­æ­¥ï¼šé€šè¿‡ç®¡ç†åå°é…ç½®èµ„æºç«™

### æ–¹å¼1: ä½¿ç”¨å·²åˆå§‹åŒ–çš„èµ„æºç«™

æ•°æ®åº“ä¸­å·²ç»æœ‰5ä¸ªèµ„æºç«™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š
1. ç™»å½•ç®¡ç†åå°
2. è¿›å…¥"æºç«™ç®¡ç†"é¡µé¢
3. æŸ¥çœ‹å·²æœ‰çš„èµ„æºç«™
4. æµ‹è¯•æ¯ä¸ªèµ„æºç«™æ˜¯å¦å¯ç”¨
5. æ ¹æ®éœ€è¦è°ƒæ•´æƒé‡æˆ–ç¦ç”¨æŸäº›èµ„æºç«™

### æ–¹å¼2: æ·»åŠ æ–°çš„èµ„æºç«™

1. ç‚¹å‡»"æ·»åŠ èµ„æºç«™"æŒ‰é’®
2. å¡«å†™èµ„æºç«™ä¿¡æ¯:
   - åç§°: ä¾‹å¦‚ "æŸæŸèµ„æº"
   - APIåœ°å€: ä¾‹å¦‚ `https://api.example.com/api.php/provide/vod`
   - æƒé‡: 1-100ï¼ˆè¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
   - çŠ¶æ€: å¯ç”¨/ç¦ç”¨
3. ä¿å­˜

### å¸¸è§èµ„æºç«™APIæ ¼å¼

å¤§å¤šæ•°CMSèµ„æºç«™ä½¿ç”¨ä»¥ä¸‹APIæ ¼å¼:
- åˆ—è¡¨: `?ac=list&pg=1`
- æœç´¢: `?ac=list&wd=å…³é”®è¯`
- è¯¦æƒ…: `?ac=detail&ids=123`
- åˆ†ç±»: `?ac=list&t=1`

---

## ğŸ¯ ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•çŸ­å‰§åŠŸèƒ½

### æ‰‹åŠ¨è§¦å‘çŸ­å‰§æŠ“å–

```bash
# æ–¹å¼1: é€šè¿‡APIè§¦å‘ï¼ˆéœ€è¦å®ç°è§¦å‘æ¥å£ï¼‰
curl -X POST http://localhost:8787/api/admin/trigger-shorts-fetch \
  -H "x-admin-key: robin_admin_secret_2024_local_development"

# æ–¹å¼2: æ¨¡æ‹ŸCronè§¦å‘
curl "http://localhost:8787/__scheduled?cron=0+*/12+*+*+*"
```

### æŸ¥çœ‹çŸ­å‰§æ•°æ®

```bash
npm run db:query -- --command="SELECT COUNT(*) FROM shorts_cache"
```

### æµ‹è¯•çŸ­å‰§éšæœºæµ

```bash
curl http://localhost:8787/api/shorts/random
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: èµ„æºç«™è¿”å›ç©ºæ•°æ®ï¼Ÿ

**åŸå› **: 
- èµ„æºç«™URLä¸æ­£ç¡®
- èµ„æºç«™éœ€è¦æˆæƒ
- èµ„æºç«™æš‚æ—¶ä¸å¯ç”¨

**è§£å†³**:
1. åœ¨ç®¡ç†åå°æµ‹è¯•æ¯ä¸ªèµ„æºç«™
2. ç¦ç”¨ä¸å¯ç”¨çš„èµ„æºç«™
3. æ·»åŠ æ–°çš„å¯ç”¨èµ„æºç«™

### Q2: ç®¡ç†åå°æ— æ³•ç™»å½•ï¼Ÿ

**åŸå› **: ADMIN_SECRET_KEY ä¸åŒ¹é…

**è§£å†³**:
1. æ£€æŸ¥ `.dev.vars` ä¸­çš„ `ADMIN_SECRET_KEY`
2. ç¡®ä¿ç®¡ç†åå°è¾“å…¥çš„å¯†é’¥ä¸€è‡´

### Q3: JWTè®¤è¯å¤±è´¥ï¼Ÿ

**åŸå› **: JWT_SECRET æœªé…ç½®

**è§£å†³**:
1. æ£€æŸ¥ `.dev.vars` ä¸­çš„ `JWT_SECRET`
2. é‡å¯åç«¯æœåŠ¡

### Q4: çŸ­å‰§æŠ“å–å¤±è´¥ï¼Ÿ

**åŸå› **: 
- SHORTS_SITES é…ç½®çš„URLä¸æ­£ç¡®
- çŸ­å‰§æºç«™ä¸å¯ç”¨

**è§£å†³**:
1. æ£€æŸ¥ `src/config.ts` ä¸­çš„ `SHORTS_SITES`
2. æ›¿æ¢ä¸ºçœŸå®çš„çŸ­å‰§èµ„æºç«™URL
3. æˆ–è€…é€šè¿‡ç®¡ç†åå°æ·»åŠ çŸ­å‰§æºç«™ï¼ˆéœ€è¦æ‰©å±•åŠŸèƒ½ï¼‰

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
wrangler tail
```

### æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡

```bash
# æŸ¥çœ‹ç”¨æˆ·æ•°
npm run db:query -- --command="SELECT COUNT(*) FROM users"

# æŸ¥çœ‹çŸ­å‰§æ•°
npm run db:query -- --command="SELECT COUNT(*) FROM shorts_cache"

# æŸ¥çœ‹èµ„æºç«™
npm run db:query -- --command="SELECT * FROM video_sources"

# æŸ¥çœ‹ä»Šæ—¥ç»Ÿè®¡
npm run db:query -- --command="SELECT * FROM daily_stats ORDER BY date DESC LIMIT 7"
```

---

## ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### 1. åˆ›å»ºç”Ÿäº§æ•°æ®åº“

```bash
npx wrangler d1 create robin-db-prod
```

è®°å½•è¿”å›çš„ `database_id`ï¼Œæ›´æ–° `wrangler.toml`:

```toml
[[d1_databases]]
binding = "DB"
database_name = "robin-db-prod"
database_id = "ä½ çš„ç”Ÿäº§æ•°æ®åº“ID"
```

### 2. åˆå§‹åŒ–ç”Ÿäº§æ•°æ®åº“

```bash
npm run db:remote:init
npx wrangler d1 execute robin-db-prod --remote --file=./seed_sources.sql
```

### 3. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡

```bash
wrangler secret put JWT_SECRET
# è¾“å…¥å¼ºå¯†ç ï¼Œä¾‹å¦‚: robin_jwt_prod_2024_ultra_secure_key_xxxxx

wrangler secret put ADMIN_SECRET_KEY
# è¾“å…¥å¼ºå¯†ç ï¼Œä¾‹å¦‚: robin_admin_prod_2024_ultra_secure_key_xxxxx

# å¯é€‰
wrangler secret put TMDB_API_KEY
wrangler secret put DINGTALK_WEBHOOK
```

### 4. éƒ¨ç½²

```bash
npm run deploy
```

### 5. éªŒè¯éƒ¨ç½²

```bash
curl https://ä½ çš„workeråŸŸå.workers.dev/
```

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„åç«¯å·²ç»å®Œå…¨é…ç½®å¥½äº†ï¼

**ä¸‹ä¸€æ­¥**:
1. é€šè¿‡ç®¡ç†åå°é…ç½®èµ„æºç«™
2. æµ‹è¯•è§†é¢‘æœç´¢å’Œæ’­æ”¾
3. é…ç½®çŸ­å‰§æºç«™
4. æµ‹è¯•çŸ­å‰§éšæœºæµ
5. å¼€å‘APPå‰ç«¯å¯¹æ¥

**éœ€è¦å¸®åŠ©?**
- æŸ¥çœ‹æ¶æ„æ–‡æ¡£
- æŸ¥çœ‹APIæ–‡æ¡£
- æ£€æŸ¥æ—¥å¿—è¾“å‡º
